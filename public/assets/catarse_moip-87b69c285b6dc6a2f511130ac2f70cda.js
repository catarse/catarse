CATARSE.UserDocument=Backbone.View.extend({onUserDocumentKeyup:function(e){var t=$(e.currentTarget),n=t.val(),r=this.validateCpf(n),i=this.validateCnpj(n);n.replace(/[.\-\_ ]/g,"").length>10&&(r||i?(t.addClass("ok").removeClass("error"),$.post("/projects/"+this.moipForm.projectId+"/backers/"+this.moipForm.backerId+"/update_info",{backer:{payer_document:n}})):t.addClass("error").removeClass("ok"))},validateCpf:function(e){var t=0,n,r;e=e.replace(/[.\-\_ ]/g,"");var i=Math.floor(parseFloat(e)/100),s=i*100,o;for(n=0;n<=8;n++)t+=i%10*(n+2),i=Math.floor(i/10);r=t%11<2?0:11-t%11,s+=r*10,t=0,i=Math.floor(s/10);for(n=0;n<=9;n++)t+=i%10*(n+2),i=Math.floor(i/10);return r=t%11<2?0:11-t%11,s+=r,parseFloat(e)===s},validateCnpj:function(e){var t,n,r,i,s,o,u,a;a=1;if(e.length<14&&e.length<15)return!1;for(i=0;i<e.length-1;i++)if(e.charAt(i)!=e.charAt(i+1)){a=0;break}if(!a){u=e.length-2,t=e.substring(0,u),n=e.substring(u),r=0,o=u-7;for(i=u;i>=1;i--)r+=t.charAt(u-i)*o--,o<2&&(o=9);s=r%11<2?0:11-r%11;if(s!=n.charAt(0))return!1;u+=1,t=e.substring(0,u),r=0,o=u-7;for(i=u;i>=1;i--)r+=t.charAt(u-i)*o--,o<2&&(o=9);return s=r%11<2?0:11-r%11,s!=n.charAt(1)?!1:!0}return!1}}),CATARSE.MoipForm=Backbone.View.extend({el:"form.moip",getMoipToken:function(e){var t=this;$("#MoipWidget").length>0?_.isFunction(e)&&e():$.post("/payment/moip/"+this.backerId+"/get_moip_token").success(function(n,r){t.paymentChoice.$("input").attr("disabled","disabled"),n.get_token_response.status=="fail"?t.checkoutFailure({Code:0,Mensagem:n.get_token_response.message}):($("#catarse_moip_form").prepend(n.widget_tag),_.isFunction(e)&&e(n))})},checkoutFailure:function(e){this.loader.hide();var t=e.length>0?e[0]:e;t.Codigo==914&&(t.Mensagem+='. Tente <a href="javascript:window.location.reload();">recarregar a página</a> e repetir a operação de pagamento.'),this.message.find("p").html(t.Mensagem),this.message.fadeIn("fast"),$('input[type="submit"]').removeAttr("disabled").show()},checkoutSuccessful:function(e){var t=this;$.post("/payment/moip/"+this.backerId+"/moip_response",{response:e}).success(function(){t.loader.hide();if(e.Status=="Cancelado")return t.checkoutFailure({Codigo:0,Mensagem:e.Classificacao.Descricao+". Verifique os dados de pagamento e tente novamente."});if(e.url){var n=$('<a target="__blank">'+e.url+"</a>");n.attr("href",e.url),$(".link_content:visible").empty().html(n),$(".payment_section:visible .subtitle").fadeIn("fast")}var r=$("#project_review").data("thank-you-path");$("#payment_type_cards_section").css("display")=="block"&&(r?location.href=r:location.href="/")})},initialize:function(){this.message=this.$(".next_step_after_valid_document .alert-danger"),this.backerId=$("input#backer_id").val(),this.projectId=$("input#project_id").val(),this.loader=this.$(".loader"),this.paymentChoice=new CATARSE.PaymentChoice,this.paymentCard=new CATARSE.PaymentCard({moipForm:this}),this.paymentSlip=new CATARSE.PaymentSlip({moipForm:this}),this.paymentAccount=new CATARSE.PaymentAccount({moipForm:this}),window.checkoutSuccessful=_.bind(this.checkoutSuccessful,this),window.checkoutFailure=_.bind(this.checkoutFailure,this)}}),CATARSE.PaymentAccount=CATARSE.UserDocument.extend({el:"#payment_type_account_section",events:{"change select#account":"onChangeAccount","click input#build_account_link":"onBuildAccountClick","keyup #user_document_account":"onUserDocumentKeyup"},initialize:function(e){this.moipForm=e.moipForm,this.$("input#user_document_account").mask("999.999.999-99")},onChangeAccount:function(e){var t=$(e.currentTarget).val();this.$("input#build_account_link").attr("disabled",t==""||t==undefined)},onBuildAccountClick:function(e){var t=this;e.preventDefault(),$(e.currentTarget).hide(),t.moipForm.loader.show(),t.moipForm.getMoipToken(function(){var e={Instituicao:$("select#account").val(),Forma:"DebitoBancario"};MoipWidget(e)})}}),CATARSE.PaymentCard=CATARSE.UserDocument.extend({el:"#payment_type_cards_section",events:{'keyup input[type="text"]':"creditCardInputValidator","keyup #payment_card_number":"onKeyupPaymentCardNumber","click input#credit_card_submit":"onSubmit","keyup #payment_card_cpf":"onUserDocumentKeyup"},initialize:function(e){this.moipForm=e.moipForm,this.$("input#payment_card_date").mask("99/99"),this.$("input#payment_card_birth").mask("99/99/9999"),this.$("input#payment_card_cpf").mask("999.999.999-99"),this.$("input#payment_card_phone").mask("(99) 9999-9999?9")},onKeyupPaymentCardNumber:function(e){this.$("input#payment_card_flag").val(this.getCardFlag($(e.currentTarget).val()))},onSubmit:function(e){var t=this;e.preventDefault(),$(e.currentTarget).hide(),t.moipForm.loader.show(),t.moipForm.getMoipToken(function(){var e={Forma:"CartaoCredito",Instituicao:t.$("input#payment_card_flag").val(),Parcelas:"1",Recebimento:"AVista",CartaoCredito:{Numero:t.$("input#payment_card_number").val(),Expiracao:t.$("input#payment_card_date").val(),CodigoSeguranca:t.$("input#payment_card_source").val(),Portador:{Nome:t.$("input#payment_card_name").val(),DataNascimento:t.$("input#payment_card_birth").val(),Telefone:t.$("input#payment_card_phone").val(),Identidade:t.$("input#payment_card_cpf").val()}}};MoipWidget(e)})},hasContent:function(e){var t=$(e).val().replace(/[\-\.\_\/\s]/g,"");return t&&t.length>0?($(e).addClass("ok").removeClass("error"),!0):($(e).addClass("error").removeClass("ok"),!1)},creditCardInputValidator:function(){var e=this,t=!0;$.each($('#payment_type_cards_section input[type="text"]'),function(n,r){t=e.hasContent(r)}),$("input#credit_card_submit").attr("disabled",!t)},getCardFlag:function(e){var t=(e+"").replace(/\s/g,"");return/^(34|37)/.test(t)&&t.length==15?"AmericanExpress":/^(51|52|53|54|55)/.test(t)&&t.length==16?"Mastercard":!/^(4)/.test(t)||t.length!=13&&t.length!=16?/^(300|301|302|303|304|305|36|38)/.test(t)&&t.length==14?"Diners":/^(38)/.test(t)&&t.length==19?"Hipercard":"Desconhecido":"Visa"}}),CATARSE.PaymentChoice=Backbone.View.extend({el:".list_payment",events:{'change input[type="radio"]':"onListPaymentChange"},onListPaymentChange:function(e){$(".payment_section").fadeOut("fast",function(){var t=$(e.currentTarget).attr("id");$("#"+t+"_section").fadeIn("fast")})},initialize:function(){this.$("input#payment_type_cards").click()}}),CATARSE.PaymentSlip=CATARSE.UserDocument.extend({el:"#payment_type_boleto_section",events:{"click input#build_boleto":"onBuildBoletoClick","click .link_content a":"onContentClick","keyup #user_document_payment_slip":"onUserDocumentPaymentSlipKeyup"},onUserDocumentPaymentSlipKeyup:function(e){var t=$(e.currentTarget);this.onUserDocumentKeyup(e),$("input#build_boleto").attr("disabled",!t.hasClass("ok"))},initialize:function(e){this.moipForm=e.moipForm,this.$("input#user_document_payment_slip").mask("999.999.999-99")},onBuildBoletoClick:function(e){var t=this;e.preventDefault(),$(e.currentTarget).hide(),t.moipForm.loader.show(),t.moipForm.getMoipToken(function(){var e={Forma:"BoletoBancario"};MoipWidget(e)})},onContentClick:function(e){window.setTimeout(function(){location.href="/thank_you";var e=$("#project_review").data("thank-you-path");e?location.href=e:location.href="/"},1e3)}}),$(function(){var e=window.moipForm=new CATARSE.MoipForm});